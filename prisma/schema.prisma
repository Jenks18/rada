// Rada Database Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User accounts (Artists, Managers, Fans)
model User {
  id            String    @id @default(cuid())
  phoneNumber   String    @unique
  email         String?   @unique
  name          String
  role          UserRole  @default(FAN)
  password      String
  avatar        String?
  verified      Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Artist-specific relations
  artist        Artist?
  
  // Fan-specific relations
  tickets       Ticket[]
  submissions   Submission[]
  fanProfiles   FanProfile[]
  
  @@index([phoneNumber])
  @@index([email])
}

enum UserRole {
  ARTIST
  MANAGER
  FAN
  ADMIN
}

// Artist profiles (The "Komi" Layer)
model Artist {
  id              String    @id @default(cuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Public profile
  stageName       String
  slug            String    @unique // For rada.to/[slug]
  bio             String?
  genre           String[]
  location        String?
  
  // Contact & Socials
  bookingWhatsApp String?
  instagram       String?
  tiktok          String?
  twitter         String?
  spotify         String?
  appleMusic      String?
  youtube         String?
  
  // Customization
  coverImage      String?
  themeColor      String    @default("#000000")
  customDomain    String?   @unique
  
  // Business
  skizaTuneCode   String?
  isVerified      Boolean   @default(false)
  isPro           Boolean   @default(false)
  proExpiresAt    DateTime?
  
  // Analytics
  pageViews       Int       @default(0)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  events          Event[]
  drops           Drop[]
  links           CustomLink[]
  merchandise     Merchandise[]
  fanProfiles     FanProfile[]
  broadcasts      Broadcast[]
  socialStats     SocialStats[]
  
  @@index([slug])
  @@index([location])
}

// Custom links for artist landing page
model CustomLink {
  id          String   @id @default(cuid())
  artistId    String
  artist      Artist   @relation(fields: [artistId], references: [id], onDelete: Cascade)
  
  title       String
  url         String
  icon        String?  // Icon name or emoji
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  clicks      Int      @default(0)
  
  createdAt   DateTime @default(now())
  
  @@index([artistId])
}

// Events & Ticketing (The "Posh" Layer)
model Event {
  id              String      @id @default(cuid())
  artistId        String
  artist          Artist      @relation(fields: [artistId], references: [id], onDelete: Cascade)
  
  // Event details
  title           String
  slug            String      @unique
  description     String?
  coverImage      String?
  
  // Location
  venue           String
  address         String
  city            String
  coordinates     String?     // lat,lng for map
  
  // Date & Time
  startDate       DateTime
  endDate         DateTime?
  doors           String?     // e.g., "8:00 PM"
  
  // Ticketing
  ticketTypes     TicketType[]
  totalCapacity   Int?
  soldTickets     Int         @default(0)
  
  // Features
  isPublished     Boolean     @default(false)
  isFeatured      Boolean     @default(false)
  allowGuestList  Boolean     @default(true)
  
  // Revenue
  totalRevenue    Float       @default(0)
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Relations
  tickets         Ticket[]
  guestList       GuestList[]
  
  @@index([artistId])
  @@index([city])
  @@index([startDate])
  @@index([slug])
}

model TicketType {
  id              String   @id @default(cuid())
  eventId         String
  event           Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  name            String   // e.g., "Early Bird", "VIP", "General Admission"
  description     String?
  price           Float
  quantity        Int
  sold            Int      @default(0)
  
  // Availability
  isActive        Boolean  @default(true)
  salesStart      DateTime?
  salesEnd        DateTime?
  
  createdAt       DateTime @default(now())
  
  tickets         Ticket[]
  
  @@index([eventId])
}

model Ticket {
  id              String      @id @default(cuid())
  eventId         String
  event           Event       @relation(fields: [eventId], references: [id])
  ticketTypeId    String
  ticketType      TicketType  @relation(fields: [ticketTypeId], references: [id])
  userId          String
  user            User        @relation(fields: [userId], references: [id])
  
  // Ticket details
  qrCode          String      @unique
  ticketNumber    String      @unique
  status          TicketStatus @default(VALID)
  
  // Payment
  phoneNumber     String
  amount          Float
  mpesaCode       String?
  paymentStatus   PaymentStatus @default(PENDING)
  
  // Check-in
  checkedIn       Boolean     @default(false)
  checkedInAt     DateTime?
  checkedInBy     String?     // Staff member who scanned
  
  createdAt       DateTime    @default(now())
  
  @@index([eventId])
  @@index([userId])
  @@index([qrCode])
  @@index([phoneNumber])
}

enum TicketStatus {
  VALID
  USED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model GuestList {
  id          String   @id @default(cuid())
  eventId     String
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  name        String
  phoneNumber String
  email       String?
  type        String   @default("Guest") // Guest, VIP, Staff, etc.
  checkedIn   Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  
  @@index([eventId])
  @@index([phoneNumber])
}

// Fan CRM (The "Cobrand" Layer)
model FanProfile {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  artistId        String
  artist          Artist   @relation(fields: [artistId], references: [id], onDelete: Cascade)
  
  // Engagement metrics
  totalSpent      Float    @default(0)
  ticketsPurchased Int     @default(0)
  lastInteraction DateTime @default(now())
  
  // Segmentation
  isSuperfan      Boolean  @default(false)
  tags            String[] // Custom tags by artist
  
  // Marketing consent
  smsOptIn        Boolean  @default(true)
  whatsappOptIn   Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([userId, artistId])
  @@index([artistId])
  @@index([isSuperfan])
}

// Drops & Submissions (Creator Tools)
model Drop {
  id              String       @id @default(cuid())
  artistId        String
  artist          Artist       @relation(fields: [artistId], references: [id], onDelete: Cascade)
  
  title           String
  slug            String       @unique
  description     String?
  coverImage      String?
  
  // Settings
  isActive        Boolean      @default(true)
  requiresApproval Boolean     @default(true)
  maxSubmissions  Int?
  allowedTypes    String[]     // ["video", "audio", "image", "link"]
  
  // Dates
  opensAt         DateTime?
  closesAt        DateTime?
  
  // Prize/Incentive
  prize           String?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  submissions     Submission[]
  
  @@index([artistId])
  @@index([slug])
}

model Submission {
  id          String           @id @default(cuid())
  dropId      String
  drop        Drop             @relation(fields: [dropId], references: [id], onDelete: Cascade)
  userId      String
  user        User             @relation(fields: [userId], references: [id])
  
  // Content
  contentType String           // "video", "audio", "image", "link"
  contentUrl  String
  caption     String?
  thumbnail   String?
  
  // Moderation
  status      SubmissionStatus @default(PENDING)
  reviewedAt  DateTime?
  reviewNote  String?
  
  // Engagement
  views       Int              @default(0)
  votes       Int              @default(0)
  
  createdAt   DateTime         @default(now())
  
  @@index([dropId])
  @@index([userId])
  @@index([status])
}

enum SubmissionStatus {
  PENDING
  APPROVED
  REJECTED
  FEATURED
}

// Broadcasting System (SMS/WhatsApp)
model Broadcast {
  id          String          @id @default(cuid())
  artistId    String
  artist      Artist          @relation(fields: [artistId], references: [id], onDelete: Cascade)
  
  title       String
  message     String
  type        BroadcastType
  
  // Targeting
  segment     String?         // "all", "superfans", "recent", custom tag
  recipients  Int             @default(0)
  
  // Status
  status      BroadcastStatus @default(DRAFT)
  sentAt      DateTime?
  
  // Results
  delivered   Int             @default(0)
  failed      Int             @default(0)
  clicked     Int             @default(0)
  
  createdAt   DateTime        @default(now())
  
  @@index([artistId])
}

enum BroadcastType {
  SMS
  WHATSAPP
  BOTH
}

enum BroadcastStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  FAILED
}

// Merchandise
model Merchandise {
  id          String   @id @default(cuid())
  artistId    String
  artist      Artist   @relation(fields: [artistId], references: [id], onDelete: Cascade)
  
  name        String
  description String?
  price       Float
  images      String[] // Array of image URLs
  
  // Inventory
  stock       Int?
  isDigital   Boolean  @default(false)
  
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([artistId])
}

// Social Stats (Channel Manager Integration)
model SocialStats {
  id          String   @id @default(cuid())
  artistId    String
  artist      Artist   @relation(fields: [artistId], references: [id], onDelete: Cascade)
  
  platform    String   // "spotify", "youtube", "tiktok", "instagram"
  
  // Metrics
  followers   Int      @default(0)
  streams     Int      @default(0)
  views       Int      @default(0)
  engagement  Float    @default(0)
  
  // Raw data (JSON)
  metadata    Json?
  
  date        DateTime @default(now())
  
  @@unique([artistId, platform, date])
  @@index([artistId])
}

// Analytics & Tracking
model PageView {
  id          String   @id @default(cuid())
  artistId    String?
  eventId     String?
  
  // Visitor info
  ipAddress   String?
  userAgent   String?
  referer     String?
  
  // Location (from IP)
  city        String?
  country     String?
  
  timestamp   DateTime @default(now())
  
  @@index([artistId])
  @@index([eventId])
  @@index([timestamp])
}
